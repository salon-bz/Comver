<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xits Socios - Publicaciones</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Estilos Base */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding-top: 70px; }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        .loading { text-align: center; padding: 50px; font-size: 1.5em; color: #555; }

        /* --- Header Fijo y Responsive --- */
        .header { 
            position: fixed; top: 0; left: 0; width: 100%; 
            background: linear-gradient(to right, #0072ff, #00c6ff); color: white; 
            padding: 10px 15px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); 
            display: flex; justify-content: space-between; align-items: center; z-index: 100; 
        }
        .header h1 { font-size: 1.3em; margin: 0; }
        .user-info { display: flex; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        .info-item { margin-right: 15px; font-weight: 600; font-size: 0.9em; }
        
        /* Botones de Acción */
        .recargar-btn { background-color: #25D366; color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; text-decoration: none; font-weight: bold; transition: background-color 0.3s; margin-right: 10px; }
        .logout-btn { background-color: #d9534f; color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        .recargar-btn:hover { background-color: #128C7E; }
        .logout-btn:hover { background-color: #c9302c; }

        /* --- Publicaciones --- */
        .post { background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); margin-bottom: 25px; overflow: hidden; }
        .post-image { width: 100%; height: 200px; object-fit: cover; }
        .post-content { padding: 15px; }
        .post-content h2 { margin-top: 0; color: #0072ff; font-size: 1.4em; }
        .view-btn { background-color: #f0ad4e; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; display: block; width: 100%; text-align: center; }
        
        /* Opciones de Compra */
        .options-container { display: none; margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; display: flex; flex-wrap: wrap; justify-content: center; }
        .option-button { background-color: #5cb85c; color: white; border: none; padding: 8px 10px; border-radius: 5px; margin: 5px; cursor: pointer; font-size: 0.9em; transition: background-color 0.3s; }

        /* Media Query para móvil */
        @media (max-width: 600px) {
            body { padding-top: 90px; }
            .header { flex-direction: column; align-items: flex-start; }
            .user-info { justify-content: space-between; width: 100%; margin-top: 10px; }
            .info-item { margin: 0 10px 0 0; font-size: 0.8em; }
            .post-content h2 { font-size: 1.2em; }
        }
    </style>
</head>
<body>
    
    <div class="header">
        <h1>Xits Socios</h1>
        <div class="user-info">
            <span class="info-item" id="user-username">Cargando...</span>
            <span class="info-item" id="user-balance">Saldo: $0.00 USD</span>
            <button class="recargar-btn" onclick="recargarSaldo()">
                <i class="fab fa-whatsapp"></i> Recargar
            </button>
            <button class="logout-btn" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i> Salir
            </button>
        </div>
    </div>

    <div class="container" id="posts-container">
        <div class="loading">Cargando publicaciones...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // TU CONFIGURACIÓN
        const firebaseConfig = {
          apiKey: "AIzaSyAcbewB4Orpx4JyaXq141GgUidJbXUrEnY",
          authDomain: "sociosxit-5f841.firebaseapp.com",
          projectId: "sociosxit-5f841",
          storageBucket: "sociosxit-5f841.firebasestorage.app",
          messagingSenderId: "364183519851",
          appId: "1:364183519851:web:52a5a95d2c57f8f9f5e72e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // VERIFICACIÓN DE SESIÓN
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadUserData(user.uid);
                await loadPosts();
            } else {
                window.location.href = 'login.html';
            }
        });

        // CARGAR SALDO Y USERNAME
        async function loadUserData(uid) {
            try {
                const userRef = doc(db, "users", uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    const data = userSnap.data();
                    document.getElementById('user-username').textContent = data.username || 'Usuario';
                    document.getElementById('user-balance').textContent = `Saldo: $${(typeof data.saldo === 'number' ? data.saldo.toFixed(2) : parseFloat(data.saldo || 0).toFixed(2))} USD`;
                } else {
                    document.getElementById('user-username').textContent = 'Error de datos';
                }
            } catch (err) {
                console.error('Error al cargar datos de usuario', err);
            }
        }

        // CARGAR PUBLICACIONES
        async function loadPosts() {
            const postsContainer = document.getElementById('posts-container');
            postsContainer.innerHTML = ''; 

            try {
                const postsCol = collection(db, "posts");
                const postsSnap = await getDocs(postsCol);
                
                if (postsSnap.empty) {
                    postsContainer.innerHTML = '<div class="loading">No hay publicaciones disponibles.</div>';
                    return;
                }

                postsSnap.forEach(docItem => {
                    const post = docItem.data();
                    postsContainer.innerHTML += createPostHTML(docItem.id, post);
                });
            } catch (err) {
                console.error('Error al cargar posts', err);
                postsContainer.innerHTML = '<div class="loading">Error al cargar publicaciones.</div>';
            }
        }
        
        // Genera el HTML de la publicación
        function createPostHTML(id, post) {
            let optionsHTML = '';
            if (post.options && post.options.length > 0) {
                post.options.forEach(option => {
                    optionsHTML += `<button class="option-button" onclick="buyService('${escapeHtml(post.title)}', ${Number(option.precio)}, '${escapeHtml(option.uso)}')">
                        $${Number(option.precio).toFixed(2)} USD (${option.uso})
                    </button>`;
                });
            } else {
                optionsHTML = '<p>Sin opciones disponibles.</p>';
            }

            return `
                <div class="post">
                    <img src="${post.imageUrl || 'https://via.placeholder.com/1000x400'}" alt="${post.title || 'Publicacion'}" class="post-image">
                    <div class="post-content">
                        <h2>${post.title || 'Título Desconocido'}</h2>
                        <p>${post.description || 'Sin descripción.'}</p>
                        <button class="view-btn" onclick="toggleOptions('${id}')">Ver Opciones</button>
                        <div id="options-${id}" class="options-container">
                            ${optionsHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Funciones Globales ---
        window.handleLogout = async () => { 
            await signOut(auth);
            window.location.href = 'login.html';
        };

        window.recargarSaldo = () => {
            const phoneNumber = '573142369516';
            const message = 'Hola quiero recargar saldo en la pagina de socios ya se que el minimo de saldo es de 3 usd.';
            const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappURL, '_blank');
        };

        window.toggleOptions = (id) => {
            var options = document.getElementById('options-' + id);
            if (!options) return;
            options.style.display = options.style.display === 'flex' ? 'none' : 'flex';
        };
        
        // Función para comprar servicio: revisa saldo y (simula) descuento
        window.buyService = async (title, price, usage) => {
             try {
                const user = auth.currentUser;
                if (!user) { alert('Debes iniciar sesión.'); return; }
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) { alert('Usuario no encontrado'); return; }
                const data = userSnap.data();
                const saldoActual = parseFloat(data.saldo || 0);
                if (saldoActual < price) {
                    alert('Saldo insuficiente. Por favor recarga.');
                    return;
                }
                // Descontar saldo (actualiza en Firestore)
                await updateDoc(userRef, { saldo: parseFloat((saldoActual - price).toFixed(2)) });
                alert(`Compra realizada: ${title} por $${price.toFixed(2)} USD. Saldo descontado.`);
                // Refrescar saldo en pantalla
                document.getElementById('user-balance').textContent = `Saldo: $${(saldoActual - price).toFixed(2)} USD`;
             } catch (err) {
                console.error('Error en la compra', err);
                alert('Ocurrió un error al realizar la compra.');
             }
        };

        // Escape html simple para evitar inyección en los botones (protección mínima)
        function escapeHtml(text) {
            if (!text) return '';
            return String(text).replace(/[&<>"'`=\/]/g, function (s) {
              return ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;',
                '/': '&#x2F;',
                '=': '&#x3D;',
                '`': '&#x60;'
              })[s];
            });
        }
    </script>
</body>
</html>