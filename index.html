<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SociosXIT - Acceso</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

  <script src="./firebase_config.js"></script>

  <style>
    /* Fondo animado con colores vivos */
    body {
      background: linear-gradient(135deg, #ff0080, #7928ca, #2af598);
      background-size: 400% 400%;
      animation: bgMove 10s ease infinite;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Poppins', sans-serif;
      overflow: hidden;
    }

    @keyframes bgMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Tarjeta principal */
    .card {
      position: relative;
      z-index: 1;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
      width: 90%;
      max-width: 400px;
    }

    /* Estilos de neón para los botones */
    .neon-button {
      background-color: #ff0080;
      box-shadow: 0 0 5px #ff0080, 0 0 10px #ff0080, 0 0 20px #ff0080;
      transition: all 0.3s ease;
    }

    .neon-button:hover {
      background-color: #e60073;
      box-shadow: 0 0 10px #ff0080, 0 0 30px #ff0080, 0 0 50px #ff0080;
    }

    /* Transiciones de vista */
    .view {
      transition: opacity 0.4s ease-in-out;
    }
  </style>
</head>
<body class="text-white">

  <div id="mainCard" class="card">
    <h1 class="text-3xl font-bold text-center mb-6 text-white">SociosXIT</h1>
    
    <div id="registerView" class="view">
      <h2 class="text-xl font-semibold mb-4 text-center">Registro</h2>
      <input id="regUser" type="text" placeholder="Usuario" class="w-full p-3 mb-4 bg-white/10 rounded border border-white/20 focus:outline-none focus:ring-2 focus:ring-[#7928ca] placeholder-white/70" />
      <input id="regPass" type="password" placeholder="Contraseña" class="w-full p-3 mb-4 bg-white/10 rounded border border-white/20 focus:outline-none focus:ring-2 focus:ring-[#7928ca] placeholder-white/70" />
      <button id="registerBtn" class="neon-button w-full p-3 rounded font-bold text-lg mb-4">Registrarse</button>
      <div class="text-center text-sm">
        ¿Ya tienes cuenta? <a href="#" onclick="show('loginView')" class="text-[#2af598] hover:underline font-medium">Iniciar Sesión</a>
      </div>
    </div>
    
    <div id="loginView" class="view hidden">
      <h2 class="text-xl font-semibold mb-4 text-center">Iniciar Sesión</h2>
      <input id="loginUser" type="text" placeholder="Usuario" class="w-full p-3 mb-4 bg-white/10 rounded border border-white/20 focus:outline-none focus:ring-2 focus:ring-[#7928ca] placeholder-white/70" />
      <input id="loginPass" type="password" placeholder="Contraseña" class="w-full p-3 mb-4 bg-white/10 rounded border border-white/20 focus:outline-none focus:ring-2 focus:ring-[#7928ca] placeholder-white/70" />
      <button id="loginBtn" class="neon-button w-full p-3 rounded font-bold text-lg mb-4">Acceder</button>
      <div class="text-center text-sm">
        ¿No tienes cuenta? <a href="#" onclick="show('registerView')" class="text-[#2af598] hover:underline font-medium">Registrarse</a>
      </div>
    </div>
    
    <div id="verifyView" class="view hidden">
      <h2 class="text-xl font-semibold mb-4 text-center">Verificación de Código</h2>
      <p class="text-sm mb-4 text-center text-white/80">Ingresa el código que te ha proporcionado un administrador.</p>
      <input id="verifyCode" type="text" placeholder="Código de verificación" class="w-full p-3 mb-4 bg-white/10 rounded border border-white/20 focus:outline-none focus:ring-2 focus:ring-[#ff0080] placeholder-white/70" />
      <button id="verifyBtn" class="neon-button w-full p-3 rounded font-bold text-lg mb-4">Verificar</button>
    </div>

  </div>

  <script>
    // --- LÓGICA DE LA APP ---

    // La variable 'db' ahora viene del archivo firebase_config.js
    const usersRef = db.ref("users");

    // Función para mostrar la vista
    function show(viewId) {
      document.querySelectorAll(".view").forEach(el => {
        el.classList.add("hidden");
      });
      document.getElementById(viewId).classList.remove("hidden");
    }

    // Comprueba si ya hay un usuario logueado al cargar
    if (sessionStorage.getItem("sociosxit_user")) {
        window.location.href = "dashboard.html";
    }

    // Registro
    document.getElementById("registerBtn").onclick = async () => {
      const user = regUser.value.trim();
      const pass = regPass.value.trim();
      if (!user || !pass) return alert("Completa todos los campos");
      if (user.length < 4 || pass.length < 6) return alert("Usuario min 4, Contraseña min 6");

      const snap = await usersRef.child(user).once("value");
      if (snap.exists()) return alert("El usuario ya existe");

      await usersRef.child(user).set({
        password: pass,
        verified: false,
        created: new Date().toISOString()
      });

      alert("Registro exitoso. Ahora verifica tu cuenta con un código.");
      show("verifyView");
    };

    // Verificación
    document.getElementById("verifyBtn").onclick = async () => {
      const code = verifyCode.value.trim();
      const user = regUser.value.trim() || loginUser.value.trim(); // Toma el usuario del registro o login
      
      if (!user) return alert("Error: No se ha detectado el usuario para verificar.");

      const codeRef = db.ref("codes/available/" + code);
      const snap = await codeRef.once("value");

      if (!snap.exists()) return alert("Código inválido o usado");
      
      // Marca el código como usado (o lo elimina)
      await codeRef.remove(); 
      
      // Verifica al usuario
      await usersRef.child(user).update({ verified: true });
      
      // Guarda y redirige
      sessionStorage.setItem("sociosxit_user", user); 
      window.location.href = "dashboard.html"; 
    };

    // Login
    document.getElementById("loginBtn").onclick = async () => {
      const user = loginUser.value.trim();
      const pass = loginPass.value.trim();
      
      const snap = await usersRef.child(user).once("value");
      
      if (!snap.exists() || snap.val().password !== pass) return alert("Datos incorrectos");
      
      // Si existe pero no está verificado
      if (!snap.val().verified) {
        // Asegúrate de que loginUser tiene el valor para que 'verifyBtn' pueda usarlo
        loginUser.value = user; 
        return show("verifyView");
      }
      
      // Si está verificado
      sessionStorage.setItem("sociosxit_user", user); 
      window.location.href = "dashboard.html"; 
    };
  </script>

</body>
</html>
