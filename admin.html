<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Xits Socios - Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#eef2f7; margin:0; padding:20px; }
    h1 { color:#0072ff; border-bottom:2px solid #0072ff; padding-bottom:10px; margin-bottom:18px; font-size:1.6em; }
    .section { background:#fff; padding:18px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-bottom:18px; }
    label { display:block; margin:8px 0 6px; font-weight:600; color:#444; }
    input, textarea, select { width:100%; max-width:520px; padding:10px; border-radius:6px; border:1px solid #ddd; box-sizing: border-box;}
    .admin-btn { background:#0072ff; color:#fff; border:0; padding:10px 16px; border-radius:8px; cursor:pointer; margin-top:10px; font-weight:600; }
    .admin-btn:hover { background:#0056e6; }
    #users-table { width:100%; border-collapse:collapse; margin-top:12px; }
    #users-table th, #users-table td { border:1px solid #ddd; padding:8px; text-align:left; font-size:0.9em; }
    #users-table th { background:#f7f7f7; }
    .top-right { position: fixed; right: 12px; top: 10px; display:flex; gap:10px; align-items:center; z-index:999; }
    .username-span { font-weight:700; color:#fff; background:rgba(0,0,0,0.12); padding:6px 10px; border-radius:8px; }
    .logout-btn { background:#d9534f; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .logout-btn:hover { background:#c9302c; }
    .option-row { display:flex; flex-wrap: wrap; gap:8px; margin-bottom:8px; align-items:flex-start; }
    .option-row input:nth-child(1) { width: 80px; } /* Precio */
    .option-row input:nth-child(2) { flex: 1; } /* Nombre */
    .option-row input:nth-child(3) { flex: 2; } /* Keys */
    .small { font-size:0.9em; color:#666; margin-top:6px; }
  </style>
</head>
<body>
  <script>
    const currentUser = localStorage.getItem('currentUser');
    const isAdmin = localStorage.getItem('isAdmin') === 'true';
    if (!currentUser || !isAdmin) { window.location.href = 'login.html'; }
  </script>

  <div class="top-right">
    <span class="username-span" id="admin-name">Cargando...</span>
    <button class="logout-btn" onclick="logout()">Cerrar sesión</button>
  </div>

  <h1><i class="fas fa-tools"></i> Panel de Administración Xits Socios</h1>

  <div class="section">
    <h2><i class="fas fa-hand-holding-usd"></i> Administrar Saldo de Socios</h2>
    <form id="balance-form" onsubmit="applyBalance(event)">
      <label for="target-username">Usuario (username):</label>
      <input id="target-username" type="text" placeholder="ej: pepito123" required />
      <label for="amount">Saldo total a establecer (USD):</label>
      <input id="amount" type="number" step="0.01" min="0" value="0" required />
      <button class="admin-btn" type="submit">Establecer Saldo</button>
      <div id="balance-msg" class="small"></div>
    </form>
  </div>

  <div class="section">
    <h2><i class="fas fa-bullhorn"></i> Crear / Añadir Publicación</h2>
    <form id="post-form" onsubmit="createPost(event)">
      <label for="post-title">Título</label>
      <input id="post-title" type="text" required />
      <label for="post-link">Foto (URL)</label>
      <input id="post-link" type="url" placeholder="https://ejemplo.com/imagen.png" required />
      <label for="post-desc">Descripción</label>
      <textarea id="post-desc" rows="3" placeholder="Descripción breve de la publicación"></textarea>

      <h3>Opciones de Servicio / Keys</h3>
      <div id="options-list"></div>
      <button type="button" class="admin-btn" onclick="addOption()">+ Añadir Opción</button>
      <div class="small">Para agregar keys separa las keys con comas (ej: KEY-A,KEY-B,KEY-C).</div>

      <div style="margin-top:12px;">
        <button class="admin-btn" type="submit">Crear Publicación</button>
        <div id="post-msg" class="small"></div>
      </div>
    </form>
  </div>

  <div class="section">
    <h2><i class="fas fa-users"></i> Lista de Usuarios</h2>
    <table id="users-table">
      <thead><tr><th>UID</th><th>Usuario</th><th>Saldo</th><th>Admin</th></tr></thead>
      <tbody id="users-tbody"></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where, doc, updateDoc, addDoc
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // Reemplaza con tu configuración REAL de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAcbewB4Orpx4JyaXq141GgUidJbXUrEnY",
      authDomain: "sociosxit-5f841.firebaseapp.com",
      projectId: "sociosxit-5f841",
      storageBucket: "sociosxit-5f841.firebasestorage.app",
      messagingSenderId: "364183519851",
      appId: "1:364183519851:web:52a5a95d2c57f8f9f5e72e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const currentUser = localStorage.getItem('currentUser');
    document.getElementById('admin-name').textContent = currentUser || 'Admin';

    // FUNCIÓN DE ADMINISTRAR SALDO
    window.applyBalance = async (e) => {
      e.preventDefault();
      const target = document.getElementById('target-username').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const msg = document.getElementById('balance-msg');
      msg.textContent = '';

      if (!target || isNaN(amount)) { msg.textContent = 'Ingresa usuario y saldo válido.'; return; }
      try {
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('username', '==', target));
        const snap = await getDocs(q);
        if (snap.empty) { msg.textContent = 'Usuario no encontrado.'; return; }

        let uid = null;
        snap.forEach(d => {
            uid = d.id; // Asumimos que el username es único
        });

        await updateDoc(doc(db, 'users', uid), { saldo: amount });
        msg.style.color = '#25A85A';
        msg.textContent = `✅ Saldo actualizado a $${amount.toFixed(2)} USD para ${target}.`;
        loadUsers(); // Recarga la lista de usuarios
      } catch (err) {
        console.error(err);
        msg.style.color = '#d9534f';
        msg.textContent = 'Error al actualizar saldo.';
      }
    };

    // AÑADIR OPCIÓN (UI)
    window.addOption = () => {
      const container = document.getElementById('options-list');
      const row = document.createElement('div');
      row.className = 'option-row';
      row.innerHTML = `
        <input class="opt-price" type="number" placeholder="Precio USD" min="0" step="0.01" required />
        <input class="opt-name" type="text" placeholder="Nombre (ej: 1 mes)" required />
        <input class="opt-keys" type="text" placeholder="Keys (separadas por coma)" />
        <button type="button" onclick="this.parentElement.remove()" style="background:#d9534f;color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer;">X</button>
      `;
      container.appendChild(row);
    };

    // FUNCIÓN DE CREAR PUBLICACIÓN
    window.createPost = async (e) => {
      e.preventDefault();
      const title = document.getElementById('post-title').value.trim();
      const imageUrl = document.getElementById('post-link').value.trim();
      const description = document.getElementById('post-desc').value.trim();
      const msg = document.getElementById('post-msg');
      msg.textContent = '';
      msg.style.color = '#d9534f';

      const options = [];
      document.querySelectorAll('#options-list .option-row').forEach(row => {
        const price = row.querySelector('.opt-price').value;
        const name = row.querySelector('.opt-name').value;
        const keysRaw = row.querySelector('.opt-keys').value;

        // Limpiar y obtener keys (filtrar vacíos/solo espacios)
        const keys = keysRaw ? keysRaw.split(',').map(k => k.trim()).filter(k => k.length > 0) : [];

        if (price && name && !isNaN(parseFloat(price))) {
          options.push({ precio: parseFloat(price), nombre: name, keys });
        }
      });

      if (!title || !imageUrl) { msg.textContent = 'Título y foto son obligatorios.'; return; }
      if (options.length === 0) { msg.textContent = 'Añade al menos una opción válida.'; return; }

      try {
        await addDoc(collection(db, 'posts'), {
          title, imageUrl, description, options, createdAt: new Date().toISOString()
        });
        msg.style.color = '#25A85A';
        msg.textContent = '✅ Publicación creada exitosamente.';
        document.getElementById('post-form').reset();
        document.getElementById('options-list').innerHTML = '';
      } catch (err) {
        console.error(err);
        msg.style.color = '#d9534f';
        msg.textContent = 'Error creando publicación.';
      }
    };

    // FUNCIÓN DE CARGAR USUARIOS
    async function loadUsers() {
      try {
        const tbody = document.getElementById('users-tbody');
        tbody.innerHTML = '';
        const usersRef = collection(db, 'users');
        const snap = await getDocs(usersRef);
        snap.forEach(u => {
          const d = u.data();
          const tr = document.createElement('tr');
          const uidSnippet = u.id.substring(0, 5) + '...';
          const saldoFormatted = `$${(parseFloat(d.saldo || 0)).toFixed(2)}`;
          const isAdminText = d.isAdmin ? '<span style="color:green;font-weight:700;">SI</span>' : 'NO';

          tr.innerHTML = `<td>${uidSnippet}</td><td>${d.username || ''}</td><td>${saldoFormatted}</td><td>${isAdminText}</td>`;
          tbody.appendChild(tr);
        });
      } catch (err) { console.error('Error al cargar usuarios:', err); }
    }

    // Función de Logout
    window.logout = () => {
      localStorage.removeItem('currentUser');
      localStorage.removeItem('currentUserId');
      localStorage.removeItem('isAdmin');
      window.location.href = 'login.html';
    };

    // init
    loadUsers();
  </script>
</body>
</html>
